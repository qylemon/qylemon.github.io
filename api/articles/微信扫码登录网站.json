{"title":"web微信扫码登录","slug":"微信扫码登录网站","date":"2020-05-11T07:06:45.897Z","updated":"2020-09-25T05:43:45.589Z","comments":true,"path":"api/articles/微信扫码登录网站.json","excerpt":"记录下网页端微信实现扫码登录的流程","covers":["http://qn.cxylt.cn/2018/5/11/QQ%E5%9B%BE%E7%89%8720180510151403.png"],"content":"<p>记录下网页端微信实现扫码登录的流程<a id=\"more\"></a></p>\n<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><ol>\n<li>首先我们需要到<a href=\"https://open.weixin.qq.com/\" target=\"_blank\" rel=\"noopener\">微信·开放平台</a>的管理中心创建一个网站应用，<img src=\"http://qn.cxylt.cn/2018/5/11/QQ%E5%9B%BE%E7%89%8720180510151403.png\" alt></li>\n<li>完成后我们会得到该网页应用的appid和appsecret</li>\n<li>在文档中我们能够看到网页应用获取用户信息的详细过程→<a href=\"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html\" target=\"_blank\" rel=\"noopener\">微信官方文档·开放平台</a></li>\n</ol>\n<h2 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 首先获取微信二维码</span><br><span class=\"line\">public String getWechatCode() &#123;</span><br><span class=\"line\">    try &#123;</span><br><span class=\"line\">        String oauthUrl = &quot;https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect&quot;;</span><br><span class=\"line\">        String redirect_uri = URLEncoder.encode(callBack, &quot;utf-8&quot;);</span><br><span class=\"line\">        oauthUrl =  oauthUrl.replace(&quot;APPID&quot;,config.appid).replace(&quot;REDIRECT_URI&quot;,config.redirect_uri).replace(&quot;SCOPE&quot;,snsapi_login);\t//其中scope的值为固定值</span><br><span class=\"line\">        return msg.success(oauthUrl);</span><br><span class=\"line\">    &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125; catch (Exception e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return null;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">2. 成功后微信会将code和state两个参数重定向到redirect_uri页面中 </span><br><span class=\"line\">public String callBackUserInfo(String code, String state) &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            //1.通过code获取access_token</span><br><span class=\"line\">            String url = &quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code&quot;;</span><br><span class=\"line\">            url = url.replace(&quot;APPID&quot;,config.appid).replace(&quot;SECRET&quot;,config.appsecret).replace(&quot;CODE&quot;,code);</span><br><span class=\"line\">            String s  = HttpUtils.httpGet(url);</span><br><span class=\"line\">\t\t\tJsonParser jp = new JsonParser();</span><br><span class=\"line\">            JsonObject jo = jp.parse(s).getAsJsonObject();</span><br><span class=\"line\"></span><br><span class=\"line\">            //2.通过access_token和openid获取用户信息</span><br><span class=\"line\">            String userInfoUrl = &quot;https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID&quot;;</span><br><span class=\"line\">            userInfoUrl = userInfoUrl.replace(&quot;ACCESS_TOKEN&quot;,jo.get(&quot;access_token&quot;).getAsString()).replace(&quot;OPENID&quot;,jo.get(&quot;openid&quot;).getAsString());</span><br><span class=\"line\"></span><br><span class=\"line\">            String userinfo = HttpUtils.httpGet(userInfoUrl);</span><br><span class=\"line\">            if (userInfoStr == null) &#123;</span><br><span class=\"line\">                return msg.fail(&quot;获取失败&quot;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            //3.根据uuid查询用户是否存在，如果存在直接登录。如果不存在则自动注册，在登录</span><br><span class=\"line\">            UserInfoModel userInfoByWechat = iUserDao.selectBy(&quot;unionId&quot;, asJsonObject.get(&quot;unionid&quot;).getAsString());</span><br><span class=\"line\">            if (userInfoByWechat != null) &#123;</span><br><span class=\"line\">                return msg.success(userInfoByWechat);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            //4.数据库添加用户信息</span><br><span class=\"line\">            String username = userInfoStr.get(&quot;nickname&quot;).toString();</span><br><span class=\"line\">            String unionid = userInfoStr.get(&quot;unionid&quot;).toString();</span><br><span class=\"line\">\t\t\t..</span><br><span class=\"line\">            UserInfoBean userInfoBean = new UserInfoBean();</span><br><span class=\"line\">            userInfoBean.setUuid(unionid);</span><br><span class=\"line\">            userInfoBean.setUsername(username);</span><br><span class=\"line\">\t\t\t..</span><br><span class=\"line\">            int result = iUserDao.insertUser(userInfoBean);</span><br><span class=\"line\">            //5.根据uuid查询新注册的用户信息</span><br><span class=\"line\">            if (result != 1) &#123;</span><br><span class=\"line\">\t\t\t\t//fail</span><br><span class=\"line\">            &#125;else&#123;</span><br><span class=\"line\">\t\t\t\t//success</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return msg.fail(&quot;&quot;);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"注意事项说明\"><a href=\"#注意事项说明\" class=\"headerlink\" title=\"注意事项说明\"></a>注意事项说明</h2><ol>\n<li>关于unionId<ol>\n<li>用户在同主体公众号授权时，getuserInfo内应当直接存在unionId属性</li>\n<li>unionId一定要提前获取到，用户在其他同主体下的产品授权登录时则会产生unionId，网上说可能碰到无法获取的情况暂未发现</li>\n<li>小程序通过getUserInfo解码得到unionId时 这里的sessionKey一定要在userinfo前得到，否则则可能出现<code>javax.crypto.BadPaddingException: pad block corrupted</code>问题；</li>\n</ol>\n</li>\n<li>微信扫码获取code时<ol>\n<li>redirect_uri 参数错误 这里可能是因为填写的回调地址错误 回调地址不需要填写详细请求地址，只需要主体域名即可，详细跳转填到项目对应变量内</li>\n<li>该链接无法访问 这可能时问题一所致，也可能时scope不为snsapi_login所致</li>\n</ol>\n</li>\n</ol>\n<h2 id=\"end\"><a href=\"#end\" class=\"headerlink\" title=\"end\"></a>end</h2>","more":"</p>\n<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><ol>\n<li>首先我们需要到<a href=\"https://open.weixin.qq.com/\" target=\"_blank\" rel=\"noopener\">微信·开放平台</a>的管理中心创建一个网站应用，<img src=\"http://qn.cxylt.cn/2018/5/11/QQ%E5%9B%BE%E7%89%8720180510151403.png\" alt></li>\n<li>完成后我们会得到该网页应用的appid和appsecret</li>\n<li>在文档中我们能够看到网页应用获取用户信息的详细过程→<a href=\"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html\" target=\"_blank\" rel=\"noopener\">微信官方文档·开放平台</a></li>\n</ol>\n<h2 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 首先获取微信二维码</span><br><span class=\"line\">public String getWechatCode() &#123;</span><br><span class=\"line\">    try &#123;</span><br><span class=\"line\">        String oauthUrl = &quot;https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect&quot;;</span><br><span class=\"line\">        String redirect_uri = URLEncoder.encode(callBack, &quot;utf-8&quot;);</span><br><span class=\"line\">        oauthUrl =  oauthUrl.replace(&quot;APPID&quot;,config.appid).replace(&quot;REDIRECT_URI&quot;,config.redirect_uri).replace(&quot;SCOPE&quot;,snsapi_login);\t//其中scope的值为固定值</span><br><span class=\"line\">        return msg.success(oauthUrl);</span><br><span class=\"line\">    &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125; catch (Exception e) &#123;</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return null;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">2. 成功后微信会将code和state两个参数重定向到redirect_uri页面中 </span><br><span class=\"line\">public String callBackUserInfo(String code, String state) &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            //1.通过code获取access_token</span><br><span class=\"line\">            String url = &quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code&quot;;</span><br><span class=\"line\">            url = url.replace(&quot;APPID&quot;,config.appid).replace(&quot;SECRET&quot;,config.appsecret).replace(&quot;CODE&quot;,code);</span><br><span class=\"line\">            String s  = HttpUtils.httpGet(url);</span><br><span class=\"line\">\t\t\tJsonParser jp = new JsonParser();</span><br><span class=\"line\">            JsonObject jo = jp.parse(s).getAsJsonObject();</span><br><span class=\"line\"></span><br><span class=\"line\">            //2.通过access_token和openid获取用户信息</span><br><span class=\"line\">            String userInfoUrl = &quot;https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID&quot;;</span><br><span class=\"line\">            userInfoUrl = userInfoUrl.replace(&quot;ACCESS_TOKEN&quot;,jo.get(&quot;access_token&quot;).getAsString()).replace(&quot;OPENID&quot;,jo.get(&quot;openid&quot;).getAsString());</span><br><span class=\"line\"></span><br><span class=\"line\">            String userinfo = HttpUtils.httpGet(userInfoUrl);</span><br><span class=\"line\">            if (userInfoStr == null) &#123;</span><br><span class=\"line\">                return msg.fail(&quot;获取失败&quot;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            //3.根据uuid查询用户是否存在，如果存在直接登录。如果不存在则自动注册，在登录</span><br><span class=\"line\">            UserInfoModel userInfoByWechat = iUserDao.selectBy(&quot;unionId&quot;, asJsonObject.get(&quot;unionid&quot;).getAsString());</span><br><span class=\"line\">            if (userInfoByWechat != null) &#123;</span><br><span class=\"line\">                return msg.success(userInfoByWechat);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            //4.数据库添加用户信息</span><br><span class=\"line\">            String username = userInfoStr.get(&quot;nickname&quot;).toString();</span><br><span class=\"line\">            String unionid = userInfoStr.get(&quot;unionid&quot;).toString();</span><br><span class=\"line\">\t\t\t..</span><br><span class=\"line\">            UserInfoBean userInfoBean = new UserInfoBean();</span><br><span class=\"line\">            userInfoBean.setUuid(unionid);</span><br><span class=\"line\">            userInfoBean.setUsername(username);</span><br><span class=\"line\">\t\t\t..</span><br><span class=\"line\">            int result = iUserDao.insertUser(userInfoBean);</span><br><span class=\"line\">            //5.根据uuid查询新注册的用户信息</span><br><span class=\"line\">            if (result != 1) &#123;</span><br><span class=\"line\">\t\t\t\t//fail</span><br><span class=\"line\">            &#125;else&#123;</span><br><span class=\"line\">\t\t\t\t//success</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return msg.fail(&quot;&quot;);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"注意事项说明\"><a href=\"#注意事项说明\" class=\"headerlink\" title=\"注意事项说明\"></a>注意事项说明</h2><ol>\n<li>关于unionId<ol>\n<li>用户在同主体公众号授权时，getuserInfo内应当直接存在unionId属性</li>\n<li>unionId一定要提前获取到，用户在其他同主体下的产品授权登录时则会产生unionId，网上说可能碰到无法获取的情况暂未发现</li>\n<li>小程序通过getUserInfo解码得到unionId时 这里的sessionKey一定要在userinfo前得到，否则则可能出现<code>javax.crypto.BadPaddingException: pad block corrupted</code>问题；</li>\n</ol>\n</li>\n<li>微信扫码获取code时<ol>\n<li>redirect_uri 参数错误 这里可能是因为填写的回调地址错误 回调地址不需要填写详细请求地址，只需要主体域名即可，详细跳转填到项目对应变量内</li>\n<li>该链接无法访问 这可能时问题一所致，也可能时scope不为snsapi_login所致</li>\n</ol>\n</li>\n</ol>\n<h2 id=\"end\"><a href=\"#end\" class=\"headerlink\" title=\"end\"></a>end</h2>","categories":[],"tags":[{"name":"微信","path":"api/tags/微信.json"}]}