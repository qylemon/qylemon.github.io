{"title":"关于静态资源上传","slug":"关于图片存储","date":"2020-05-09T03:40:14.161Z","updated":"2020-09-25T05:53:07.170Z","comments":true,"path":"api/articles/关于图片存储.json","excerpt":null,"covers":["https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/1cff2eb9a3c850bc97a101346ba1aba340ecae9f02df0b624fbb66c65b5855ffcbab148581dd8bb77e3acaec47e77489?pictype=scale&amp;from=30013&amp;version=3.3.3.3&amp;uin=1643994375&amp;fname=jingtai.png&amp;size=750"],"content":"<p>这几天在浏览静态相关的文章，希望能让这边静态上传速度上做优化调整在看到这张图后让我产生了新的想法，如果改为前端传递是否能够更快一步呢 <img src=\"https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/1cff2eb9a3c850bc97a101346ba1aba340ecae9f02df0b624fbb66c65b5855ffcbab148581dd8bb77e3acaec47e77489?pictype=scale&amp;from=30013&amp;version=3.3.3.3&amp;uin=1643994375&amp;fname=jingtai.png&amp;size=750\" alt></p>\n<h2 id=\"前端or后端？\"><a href=\"#前端or后端？\" class=\"headerlink\" title=\"前端or后端？\"></a>前端or后端？</h2><p>后端之前已经有记录过了效果属于正常状态 这次尝试了前端(小程序)上传记录下详细过程，这里依旧使用七牛云。</p>\n<h2 id=\"图片上传\"><a href=\"#图片上传\" class=\"headerlink\" title=\"图片上传\"></a>图片上传</h2><p>那么在上传前我们需要缕清上传需要用到哪些必须操作</p>\n<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><ol>\n<li>小程序上传图片需要使用到两个官方api<ol>\n<li>wx.chooseImage // 获取图片信息 得到临时路径</li>\n<li>wx.uploadFile  // 文件上传</li>\n</ol>\n</li>\n<li>以及我们图片上传需要七牛的token</li>\n</ol>\n<h3 id=\"关于上传的token\"><a href=\"#关于上传的token\" class=\"headerlink\" title=\"关于上传的token\"></a>关于上传的token</h3><h4 id=\"是否前台生成token\"><a href=\"#是否前台生成token\" class=\"headerlink\" title=\"是否前台生成token\"></a>是否前台生成token</h4><p>这里认为需要在前台配置ak，sk不够安全，所以还是通过后台获取</p>\n<h4 id=\"是否每次上传都获取token\"><a href=\"#是否每次上传都获取token\" class=\"headerlink\" title=\"是否每次上传都获取token\"></a>是否每次上传都获取token</h4><p>目前我是这样做的，后台通过生成后保存到redis提高响应速度</p>\n<h3 id=\"实现如下\"><a href=\"#实现如下\" class=\"headerlink\" title=\"实现如下\"></a>实现如下</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uploadImg()&#123;</span><br><span class=\"line\">  const that = this;</span><br><span class=\"line\">  const imgToken = tools.getToken(); // 取出</span><br><span class=\"line\">  </span><br><span class=\"line\">  // 上传图片</span><br><span class=\"line\">  wx.chooseImage(&#123;  </span><br><span class=\"line\">    count: 1, //上传限制数量</span><br><span class=\"line\">    sizeType: [&apos;original&apos;, &apos;compressed&apos;],  //原图/压缩图 类型均可</span><br><span class=\"line\">    sourceType: [&apos;album&apos;, &apos;camera&apos;],  //来源可拍摄可相册</span><br><span class=\"line\">    success(res)&#123;</span><br><span class=\"line\">      that.tempUrl = res.tempFilePaths[0];</span><br><span class=\"line\">      wx.uploadFile(&#123;</span><br><span class=\"line\">        url: &apos;https://upload-z0.qiniup.com&apos;,</span><br><span class=\"line\">        name: &apos;file&apos;,</span><br><span class=\"line\">        filePath: tempUrl,</span><br><span class=\"line\">        header: &#123;</span><br><span class=\"line\">          &apos;Content-Type&apos;: &apos;multipart/form-data&apos;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        formData: &#123;</span><br><span class=\"line\">          token: imgToken</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        success: function (res) &#123;</span><br><span class=\"line\">          console.log(res);</span><br><span class=\"line\">          </span><br><span class=\"line\">          let temp = JSON.parse(res.data)</span><br><span class=\"line\">          that.imageUrl = domain + temp.key // 拼接key得正式图片地址，存入数据库的图片值&apos;</span><br><span class=\"line\">          that.setData(&#123;</span><br><span class=\"line\">            img:that.imageUrl</span><br><span class=\"line\">          &#125;)            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure>\n<h2 id=\"图片压缩\"><a href=\"#图片压缩\" class=\"headerlink\" title=\"图片压缩\"></a>图片压缩</h2><p>既然提到速度 那就可以考虑对图片进行压缩处理，小程序有提供相关api，但看社区提到无效可能有一定弊端吧，这里选择的是canvas实现该功能。</p>\n<h3 id=\"实现如下-1\"><a href=\"#实现如下-1\" class=\"headerlink\" title=\"实现如下\"></a>实现如下</h3><p>这里实现有两步</p>\n<ol>\n<li><p>需要在wxml中添加canvas标签</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;canvas canvas-id=&quot;canvas&quot; style=&quot;width:&#123;&#123;cWidth&#125;&#125;px;height:&#123;&#123;cHeight&#125;&#125;px;position: absolute;left:-1000px;top:-1000px;&quot;&gt;&lt;/canvas&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取图片信息实现压缩</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 获取图片信息</span><br><span class=\"line\">wx.getImageInfo(&#123;</span><br><span class=\"line\">  src: res.tempFilePaths[0],  </span><br><span class=\"line\">    success: function(res)&#123;</span><br><span class=\"line\">      //---------利用canvas压缩图片--------------</span><br><span class=\"line\">      var ratio = 2;</span><br><span class=\"line\">      var canvasWidth = res.width //图片原始长宽</span><br><span class=\"line\">      var canvasHeight = res.height</span><br><span class=\"line\">      while (canvasWidth &gt; 400 || canvasHeight &gt; 400)&#123;// 保证宽高在400以内</span><br><span class=\"line\">          canvasWidth = Math.trunc(res.width / ratio)</span><br><span class=\"line\">          canvasHeight = Math.trunc(res.height / ratio)</span><br><span class=\"line\">          ratio++;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      that.setData(&#123;</span><br><span class=\"line\">        cWidth: canvasWidth,</span><br><span class=\"line\">        cHeight: canvasHeight</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      var ctx= wx.createCanvasContext(&apos;canvas&apos;)</span><br><span class=\"line\">      ctx.drawImage(res.path, 0, 0, canvasWidth, canvasHeight)</span><br><span class=\"line\">      ctx.draw(false, setTimeout(function()&#123;</span><br><span class=\"line\">          wx.canvasToTempFilePath(&#123;</span><br><span class=\"line\">              canvasId: &apos;canvas&apos;,</span><br><span class=\"line\">              destWidth: canvasWidth,</span><br><span class=\"line\">              destHeight: canvasHeight,</span><br><span class=\"line\">              success: function (res) &#123;</span><br><span class=\"line\">                  console.log(res.tempFilePath)//最终图片路径</span><br><span class=\"line\">              &#125;,</span><br><span class=\"line\">              fail: function (res) &#123;</span><br><span class=\"line\">                  console.log(res.errMsg)</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">      &#125;,200)) // 需要时间绘制</span><br><span class=\"line\">      </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: function(res)&#123;</span><br><span class=\"line\">        console.log(res.errMsg)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"end\"><a href=\"#end\" class=\"headerlink\" title=\"end\"></a>end</h2>","more":"<p>这几天在浏览静态相关的文章，希望能让这边静态上传速度上做优化调整在看到这张图后让我产生了新的想法，如果改为前端传递是否能够更快一步呢 <img src=\"https://picabstract-preview-ftn.weiyun.com/ftn_pic_abs_v3/1cff2eb9a3c850bc97a101346ba1aba340ecae9f02df0b624fbb66c65b5855ffcbab148581dd8bb77e3acaec47e77489?pictype=scale&amp;from=30013&amp;version=3.3.3.3&amp;uin=1643994375&amp;fname=jingtai.png&amp;size=750\" alt></p>\n<h2 id=\"前端or后端？\"><a href=\"#前端or后端？\" class=\"headerlink\" title=\"前端or后端？\"></a>前端or后端？</h2><p>后端之前已经有记录过了效果属于正常状态 这次尝试了前端(小程序)上传记录下详细过程，这里依旧使用七牛云。</p>\n<h2 id=\"图片上传\"><a href=\"#图片上传\" class=\"headerlink\" title=\"图片上传\"></a>图片上传</h2><p>那么在上传前我们需要缕清上传需要用到哪些必须操作</p>\n<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><ol>\n<li>小程序上传图片需要使用到两个官方api<ol>\n<li>wx.chooseImage // 获取图片信息 得到临时路径</li>\n<li>wx.uploadFile  // 文件上传</li>\n</ol>\n</li>\n<li>以及我们图片上传需要七牛的token</li>\n</ol>\n<h3 id=\"关于上传的token\"><a href=\"#关于上传的token\" class=\"headerlink\" title=\"关于上传的token\"></a>关于上传的token</h3><h4 id=\"是否前台生成token\"><a href=\"#是否前台生成token\" class=\"headerlink\" title=\"是否前台生成token\"></a>是否前台生成token</h4><p>这里认为需要在前台配置ak，sk不够安全，所以还是通过后台获取</p>\n<h4 id=\"是否每次上传都获取token\"><a href=\"#是否每次上传都获取token\" class=\"headerlink\" title=\"是否每次上传都获取token\"></a>是否每次上传都获取token</h4><p>目前我是这样做的，后台通过生成后保存到redis提高响应速度</p>\n<h3 id=\"实现如下\"><a href=\"#实现如下\" class=\"headerlink\" title=\"实现如下\"></a>实现如下</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uploadImg()&#123;</span><br><span class=\"line\">  const that = this;</span><br><span class=\"line\">  const imgToken = tools.getToken(); // 取出</span><br><span class=\"line\">  </span><br><span class=\"line\">  // 上传图片</span><br><span class=\"line\">  wx.chooseImage(&#123;  </span><br><span class=\"line\">    count: 1, //上传限制数量</span><br><span class=\"line\">    sizeType: [&apos;original&apos;, &apos;compressed&apos;],  //原图/压缩图 类型均可</span><br><span class=\"line\">    sourceType: [&apos;album&apos;, &apos;camera&apos;],  //来源可拍摄可相册</span><br><span class=\"line\">    success(res)&#123;</span><br><span class=\"line\">      that.tempUrl = res.tempFilePaths[0];</span><br><span class=\"line\">      wx.uploadFile(&#123;</span><br><span class=\"line\">        url: &apos;https://upload-z0.qiniup.com&apos;,</span><br><span class=\"line\">        name: &apos;file&apos;,</span><br><span class=\"line\">        filePath: tempUrl,</span><br><span class=\"line\">        header: &#123;</span><br><span class=\"line\">          &apos;Content-Type&apos;: &apos;multipart/form-data&apos;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        formData: &#123;</span><br><span class=\"line\">          token: imgToken</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        success: function (res) &#123;</span><br><span class=\"line\">          console.log(res);</span><br><span class=\"line\">          </span><br><span class=\"line\">          let temp = JSON.parse(res.data)</span><br><span class=\"line\">          that.imageUrl = domain + temp.key // 拼接key得正式图片地址，存入数据库的图片值&apos;</span><br><span class=\"line\">          that.setData(&#123;</span><br><span class=\"line\">            img:that.imageUrl</span><br><span class=\"line\">          &#125;)            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">      </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure>\n<h2 id=\"图片压缩\"><a href=\"#图片压缩\" class=\"headerlink\" title=\"图片压缩\"></a>图片压缩</h2><p>既然提到速度 那就可以考虑对图片进行压缩处理，小程序有提供相关api，但看社区提到无效可能有一定弊端吧，这里选择的是canvas实现该功能。</p>\n<h3 id=\"实现如下-1\"><a href=\"#实现如下-1\" class=\"headerlink\" title=\"实现如下\"></a>实现如下</h3><p>这里实现有两步</p>\n<ol>\n<li><p>需要在wxml中添加canvas标签</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;canvas canvas-id=&quot;canvas&quot; style=&quot;width:&#123;&#123;cWidth&#125;&#125;px;height:&#123;&#123;cHeight&#125;&#125;px;position: absolute;left:-1000px;top:-1000px;&quot;&gt;&lt;/canvas&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取图片信息实现压缩</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 获取图片信息</span><br><span class=\"line\">wx.getImageInfo(&#123;</span><br><span class=\"line\">  src: res.tempFilePaths[0],  </span><br><span class=\"line\">    success: function(res)&#123;</span><br><span class=\"line\">      //---------利用canvas压缩图片--------------</span><br><span class=\"line\">      var ratio = 2;</span><br><span class=\"line\">      var canvasWidth = res.width //图片原始长宽</span><br><span class=\"line\">      var canvasHeight = res.height</span><br><span class=\"line\">      while (canvasWidth &gt; 400 || canvasHeight &gt; 400)&#123;// 保证宽高在400以内</span><br><span class=\"line\">          canvasWidth = Math.trunc(res.width / ratio)</span><br><span class=\"line\">          canvasHeight = Math.trunc(res.height / ratio)</span><br><span class=\"line\">          ratio++;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      that.setData(&#123;</span><br><span class=\"line\">        cWidth: canvasWidth,</span><br><span class=\"line\">        cHeight: canvasHeight</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      var ctx= wx.createCanvasContext(&apos;canvas&apos;)</span><br><span class=\"line\">      ctx.drawImage(res.path, 0, 0, canvasWidth, canvasHeight)</span><br><span class=\"line\">      ctx.draw(false, setTimeout(function()&#123;</span><br><span class=\"line\">          wx.canvasToTempFilePath(&#123;</span><br><span class=\"line\">              canvasId: &apos;canvas&apos;,</span><br><span class=\"line\">              destWidth: canvasWidth,</span><br><span class=\"line\">              destHeight: canvasHeight,</span><br><span class=\"line\">              success: function (res) &#123;</span><br><span class=\"line\">                  console.log(res.tempFilePath)//最终图片路径</span><br><span class=\"line\">              &#125;,</span><br><span class=\"line\">              fail: function (res) &#123;</span><br><span class=\"line\">                  console.log(res.errMsg)</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">      &#125;,200)) // 需要时间绘制</span><br><span class=\"line\">      </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: function(res)&#123;</span><br><span class=\"line\">        console.log(res.errMsg)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"end\"><a href=\"#end\" class=\"headerlink\" title=\"end\"></a>end</h2>","categories":[],"tags":[{"name":"静态存储","path":"api/tags/静态存储.json"}]}