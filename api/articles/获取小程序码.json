{"title":"小程序获取二维码","slug":"获取小程序码","date":"2020-02-19T01:50:44.594Z","updated":"2020-03-05T09:13:54.136Z","comments":true,"path":"api/articles/获取小程序码.json","excerpt":"小程序本身通过提供的页面方法能够实现右上角分享给朋友，但是其他平台却不能直发，通常大家的解决方式是使用canvas做一张带小程序码的海报分享图，以下是微信提供的服务端API。","covers":null,"content":"<p>小程序本身通过提供的页面方法能够实现右上角分享给朋友，但是其他平台却不能直发，通常大家的解决方式是使用canvas做一张带小程序码的海报分享图，以下是微信提供的服务端API。<a id=\"more\"></a></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">接口名称</th>\n<th style=\"text-align:center\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">createQRCode</td>\n<td style=\"text-align:center\">可接受path参数较长，生成个数10W</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">getUnlimited</td>\n<td style=\"text-align:center\">可接受页面参数较短，生成个数不受限</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">get</td>\n<td style=\"text-align:center\">可接受path参数较长，生成个数10W</td>\n</tr>\n</tbody>\n</table>\n<p>其他从文档中并未发现明显区别，下面记录一下生成和小程序的测试方法，canvas将会在后续前端文章中补充</p>\n<h2 id=\"操作如下\"><a href=\"#操作如下\" class=\"headerlink\" title=\"操作如下\"></a>操作如下</h2><h3 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h3><p>服务端总共需要调用两次接口 首先需要获取到必须参数accessToken值，调用如下方法</p>\n<ol>\n<li>getAccessToken<blockquote>\n<p>GET <a href=\"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET\" target=\"_blank\" rel=\"noopener\">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</a></p>\n</blockquote>\n</li>\n</ol>\n<h4 id=\"注意点\"><a href=\"#注意点\" class=\"headerlink\" title=\"注意点\"></a>注意点</h4><p>这里的accessToken每天限量2k，需要保存下来使用</p>\n<p>然后调用生成code的方法</p>\n<ol start=\"2\">\n<li>getUnlimited<blockquote>\n<p>POST <a href=\"https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=ACCESS_TOKEN\" target=\"_blank\" rel=\"noopener\">https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=ACCESS_TOKEN</a></p>\n</blockquote>\n</li>\n</ol>\n<p>参数通过scene传递 最大支持32个字符</p>\n<h4 id=\"注意点-1\"><a href=\"#注意点-1\" class=\"headerlink\" title=\"注意点\"></a>注意点</h4><p>这里的access_token是直接当作parameter的，scene参数一定要以raw的形式传递</p>\n<h3 id=\"客户端\"><a href=\"#客户端\" class=\"headerlink\" title=\"客户端\"></a>客户端</h3><p>写功能时肯定还没有上线 那么我们如何测试呢，操作如下</p>\n<ol>\n<li>将做好的画布海报授权保存到设备</li>\n<li><p>跳转到的页面中onload方法中加入如下代码</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Page(&#123;</span><br><span class=\"line\">  onLoad (options) &#123;</span><br><span class=\"line\">    // scene 需要使用 decodeURIComponent 才能获取到生成二维码时传入的 scene</span><br><span class=\"line\">    const scene = decodeURIComponent(options.scene)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>将编译修改为二维码编译，打开刚刚保存的分享海报，就能够获取scene参数啦</p>\n</li>\n</ol>\n<h4 id=\"注意点-2\"><a href=\"#注意点-2\" class=\"headerlink\" title=\"注意点\"></a>注意点</h4><p>这里生成的qrcode 并不能直接上canvas，因为画布不支持base64，这里我们需要将其转化为普通的网络图片 之后再使用wx.getImageInfo或者wx.chooseImage进行调用</p>\n<h4 id=\"转化方式如下\"><a href=\"#转化方式如下\" class=\"headerlink\" title=\"转化方式如下\"></a>转化方式如下</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64src.js</span><br><span class=\"line\"></span><br><span class=\"line\">const fsm = wx.getFileSystemManager();</span><br><span class=\"line\">const FILE_BASE_NAME = &apos;tmp_base64src&apos;; //自定义文件名</span><br><span class=\"line\"></span><br><span class=\"line\">function base64src(base64data, cb) &#123;</span><br><span class=\"line\">  const [, format, bodyData] = /data:image\\/(\\w+);base64,(.*)/.exec(base64data) || [];</span><br><span class=\"line\">  if (!format) &#123;</span><br><span class=\"line\">    return (new Error(&apos;ERROR_BASE64SRC_PARSE&apos;));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  const filePath = `$&#123;wx.env.USER_DATA_PATH&#125;/$&#123;FILE_BASE_NAME&#125;.$&#123;format&#125;`;</span><br><span class=\"line\">  const buffer = wx.base64ToArrayBuffer(bodyData);</span><br><span class=\"line\">  fsm.writeFile(&#123;</span><br><span class=\"line\">    filePath,</span><br><span class=\"line\">    data: buffer,</span><br><span class=\"line\">    encoding: &apos;binary&apos;,</span><br><span class=\"line\">    success() &#123;</span><br><span class=\"line\">      cb(filePath);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fail() &#123;</span><br><span class=\"line\">      return (new Error(&apos;ERROR_BASE64SRC_WRITE&apos;));</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">export &#123; base64src &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">//share.js</span><br><span class=\"line\">import &#123; base64src &#125; from &apos;../../utils/base64src.js&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">Page(&#123;</span><br><span class=\"line\">  data: &#123;</span><br><span class=\"line\">\tbaseImg:&quot;/data:image/png;base64,xxxxx==&quot;</span><br><span class=\"line\">\t...</span><br><span class=\"line\"></span><br><span class=\"line\">  onLoad: function () &#123;</span><br><span class=\"line\">\t···</span><br><span class=\"line\">    base64src(this.data.base, res =&gt; &#123;</span><br><span class=\"line\">      console.log(res) // 返回图片地址，直接赋值到image标签即可</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">\t···</span><br></pre></td></tr></table></figure>\n<p>如上就能够完成了 这里顺嘴一提 getUnlimited虽然对总数没有限制 但是每分钟限制5k 如果大量生成 官方说是建议提前生成 这个自己研究吧(<em>^_^</em>)</p>\n<h2 id=\"end\"><a href=\"#end\" class=\"headerlink\" title=\"end\"></a>end</h2>","more":"</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">接口名称</th>\n<th style=\"text-align:center\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">createQRCode</td>\n<td style=\"text-align:center\">可接受path参数较长，生成个数10W</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">getUnlimited</td>\n<td style=\"text-align:center\">可接受页面参数较短，生成个数不受限</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">get</td>\n<td style=\"text-align:center\">可接受path参数较长，生成个数10W</td>\n</tr>\n</tbody>\n</table>\n<p>其他从文档中并未发现明显区别，下面记录一下生成和小程序的测试方法，canvas将会在后续前端文章中补充</p>\n<h2 id=\"操作如下\"><a href=\"#操作如下\" class=\"headerlink\" title=\"操作如下\"></a>操作如下</h2><h3 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h3><p>服务端总共需要调用两次接口 首先需要获取到必须参数accessToken值，调用如下方法</p>\n<ol>\n<li>getAccessToken<blockquote>\n<p>GET <a href=\"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET\" target=\"_blank\" rel=\"noopener\">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</a></p>\n</blockquote>\n</li>\n</ol>\n<h4 id=\"注意点\"><a href=\"#注意点\" class=\"headerlink\" title=\"注意点\"></a>注意点</h4><p>这里的accessToken每天限量2k，需要保存下来使用</p>\n<p>然后调用生成code的方法</p>\n<ol start=\"2\">\n<li>getUnlimited<blockquote>\n<p>POST <a href=\"https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=ACCESS_TOKEN\" target=\"_blank\" rel=\"noopener\">https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=ACCESS_TOKEN</a></p>\n</blockquote>\n</li>\n</ol>\n<p>参数通过scene传递 最大支持32个字符</p>\n<h4 id=\"注意点-1\"><a href=\"#注意点-1\" class=\"headerlink\" title=\"注意点\"></a>注意点</h4><p>这里的access_token是直接当作parameter的，scene参数一定要以raw的形式传递</p>\n<h3 id=\"客户端\"><a href=\"#客户端\" class=\"headerlink\" title=\"客户端\"></a>客户端</h3><p>写功能时肯定还没有上线 那么我们如何测试呢，操作如下</p>\n<ol>\n<li>将做好的画布海报授权保存到设备</li>\n<li><p>跳转到的页面中onload方法中加入如下代码</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Page(&#123;</span><br><span class=\"line\">  onLoad (options) &#123;</span><br><span class=\"line\">    // scene 需要使用 decodeURIComponent 才能获取到生成二维码时传入的 scene</span><br><span class=\"line\">    const scene = decodeURIComponent(options.scene)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>将编译修改为二维码编译，打开刚刚保存的分享海报，就能够获取scene参数啦</p>\n</li>\n</ol>\n<h4 id=\"注意点-2\"><a href=\"#注意点-2\" class=\"headerlink\" title=\"注意点\"></a>注意点</h4><p>这里生成的qrcode 并不能直接上canvas，因为画布不支持base64，这里我们需要将其转化为普通的网络图片 之后再使用wx.getImageInfo或者wx.chooseImage进行调用</p>\n<h4 id=\"转化方式如下\"><a href=\"#转化方式如下\" class=\"headerlink\" title=\"转化方式如下\"></a>转化方式如下</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64src.js</span><br><span class=\"line\"></span><br><span class=\"line\">const fsm = wx.getFileSystemManager();</span><br><span class=\"line\">const FILE_BASE_NAME = &apos;tmp_base64src&apos;; //自定义文件名</span><br><span class=\"line\"></span><br><span class=\"line\">function base64src(base64data, cb) &#123;</span><br><span class=\"line\">  const [, format, bodyData] = /data:image\\/(\\w+);base64,(.*)/.exec(base64data) || [];</span><br><span class=\"line\">  if (!format) &#123;</span><br><span class=\"line\">    return (new Error(&apos;ERROR_BASE64SRC_PARSE&apos;));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  const filePath = `$&#123;wx.env.USER_DATA_PATH&#125;/$&#123;FILE_BASE_NAME&#125;.$&#123;format&#125;`;</span><br><span class=\"line\">  const buffer = wx.base64ToArrayBuffer(bodyData);</span><br><span class=\"line\">  fsm.writeFile(&#123;</span><br><span class=\"line\">    filePath,</span><br><span class=\"line\">    data: buffer,</span><br><span class=\"line\">    encoding: &apos;binary&apos;,</span><br><span class=\"line\">    success() &#123;</span><br><span class=\"line\">      cb(filePath);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    fail() &#123;</span><br><span class=\"line\">      return (new Error(&apos;ERROR_BASE64SRC_WRITE&apos;));</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">export &#123; base64src &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">//share.js</span><br><span class=\"line\">import &#123; base64src &#125; from &apos;../../utils/base64src.js&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">Page(&#123;</span><br><span class=\"line\">  data: &#123;</span><br><span class=\"line\">\tbaseImg:&quot;/data:image/png;base64,xxxxx==&quot;</span><br><span class=\"line\">\t...</span><br><span class=\"line\"></span><br><span class=\"line\">  onLoad: function () &#123;</span><br><span class=\"line\">\t···</span><br><span class=\"line\">    base64src(this.data.base, res =&gt; &#123;</span><br><span class=\"line\">      console.log(res) // 返回图片地址，直接赋值到image标签即可</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">\t···</span><br></pre></td></tr></table></figure>\n<p>如上就能够完成了 这里顺嘴一提 getUnlimited虽然对总数没有限制 但是每分钟限制5k 如果大量生成 官方说是建议提前生成 这个自己研究吧(<em>^_^</em>)</p>\n<h2 id=\"end\"><a href=\"#end\" class=\"headerlink\" title=\"end\"></a>end</h2>","categories":[{"name":"小程序","path":"api/categories/小程序.json"}],"tags":[{"name":"微信小程序","path":"api/tags/微信小程序.json"}]}